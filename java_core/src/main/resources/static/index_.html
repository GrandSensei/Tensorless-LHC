<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CERN Particle Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
        }
        .header {
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .title { color: #00d4ff; font-size: 24px; font-weight: bold; }
        .status { color: #00ff00; font-size: 14px; animation: blink 2s infinite; }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 80vh;
        }

        .panel {
            background: #1e1e1e;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* The Live Feed Table */
        #log-container {
            height: 400px;
            overflow-y: auto;
            border-top: 1px solid #333;
            font-size: 12px;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #2a2a2a; }
        th { color: #888; }
        .correct { color: #00ff00; }
        .wrong { color: #ff0055; font-weight: bold; }

        /* Stats Cards */
        .stats-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .card { background: #2a2a2a; padding: 10px; flex: 1; text-align: center; border-radius: 4px; }
        .card h3 { margin: 0; font-size: 28px; color: #fff; }
        .card span { font-size: 12px; color: #888; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="header">
    <div class="title">LHC PARTICLE INGESTION SYSTEM</div>
    <div class="status">‚óè LIVE CONNECTION ACTIVE</div>
</div>

<div class="grid">
    <div class="left-col">
        <div class="stats-row">
            <div class="card">
                <h3 id="total-count">0</h3>
                <span>EVENTS PROCESSED</span>
            </div>
            <div class="card">
                <h3 id="accuracy-display" style="color: #00d4ff;">0%</h3>
                <span>REAL-TIME ACCURACY</span>
            </div>
            <div class="card">
                <h3 id="avg-conf">0%</h3>
                <span>AVG CONFIDENCE</span>
            </div>
        </div>

        <div class="panel">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>

    <div class="panel">
        <h4 style="margin-top:0; color:#888;">INCOMING EVENT STREAM</h4>
        <div id="log-container">
            <table id="log-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>ACTUAL</th>
                    <th>PREDICTED</th>
                    <th>CONF</th>
                    <th>ENERGY</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. SETUP CHARTS ---
    const ctx = document.getElementById('distributionChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Electron', 'Pion', 'Muon', 'Gamma'],
            datasets: [{
                label: 'Particle Count',
                data: [0, 0, 0, 0],
                backgroundColor: ['#00d4ff', '#ff0055', '#00ff00', '#ffff00'],
                borderColor: '#1e1e1e',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false }, title: { display: true, text: 'Detected Particle Distribution', color: '#888' } },
            scales: { y: { grid: { color: '#333' }, ticks: { color: '#888' } }, x: { ticks: { color: '#888' } } }
        }
    });

    // --- 2. STATE ---
    let total = 0;
    let correct = 0;
    let confSum = 0;
    const typeMap = { "Electron": 0, "Pion": 1, "Muon": 2, "Gamma": 3 };

    // --- 3. CONNECT TO BACKEND ---
    const eventSource = new EventSource("http://localhost:8080/stream");

    eventSource.addEventListener("particle-event", function(event) {
        const data = JSON.parse(event.data);

        // Update State
        total++;
        if(data.correct) correct++;
        confSum += data.conf;

        // Update Top Cards
        document.getElementById('total-count').innerText = total;
        document.getElementById('accuracy-display').innerText = (correct / total * 100).toFixed(1) + "%";
        document.getElementById('avg-conf').innerText = (confSum / total).toFixed(1) + "%";

        // Update Chart
        const idx = typeMap[data.predicted];
        if(idx !== undefined) {
            chart.data.datasets[0].data[idx]++;
            chart.update('none'); // 'none' mode prevents animation lag on high speed
        }

        // Update Table
        const tbody = document.querySelector("#log-table tbody");
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>#${data.id}</td>
                <td>${data.actual}</td>
                <td class="${data.correct ? 'correct' : 'wrong'}">${data.predicted}</td>
                <td>${data.conf.toFixed(1)}%</td>
                <td>${data.energy.toFixed(0)} MeV</td>
            `;
        tbody.prepend(row);

        // Limit table to 50 rows to prevent crashing browser
        if(tbody.children.length > 50) tbody.removeChild(tbody.lastChild);
    });
</script>
</body>
</html>